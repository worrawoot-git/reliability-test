<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ß‡∏¥‡∏à‡∏±‡∏¢ (Export Excel/PDF)</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            --primary: #4f46e5;
            --secondary: #4338ca;
            --bg: #f9fafb;
            --surface: #ffffff;
            --pass: #059669;
            --fail: #dc2626;
            --excel: #107c41;
            --pdf: #b30b00;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--bg);
            color: #1f2937;
            padding: 20px;
            margin: 0;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: var(--surface);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: var(--primary);
            margin-bottom: 25px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 20px;
        }

        .tab-btn {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            background-color: #eef2ff;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.4s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Forms */
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; }
        
        input[type="number"], textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
        }

        textarea { height: 200px; font-family: monospace; resize: vertical; }

        /* Buttons */
        .btn-group { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;}
        
        button {
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-calc { background-color: var(--primary); color: white; flex: 2; }
        .btn-calc:hover { background-color: var(--secondary); }

        .btn-reset { background-color: #e5e7eb; color: #374151; flex: 1; }
        .btn-reset:hover { background-color: #d1d5db; }

        .btn-excel { background-color: var(--excel); color: white; flex: 1; display: flex; align-items: center; justify-content: center; gap: 5px;}
        .btn-excel:hover { background-color: #0c5e31; }

        .btn-pdf { background-color: var(--pdf); color: white; flex: 1; display: flex; align-items: center; justify-content: center; gap: 5px;}
        .btn-pdf:hover { background-color: #8a0800; }

        .export-area {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed #d1d5db;
            display: flex;
            gap: 10px;
        }

        /* Results */
        .result-card {
            margin-top: 20px;
            padding: 20px;
            background-color: #ecfdf5;
            border: 1px solid #10b981;
            border-radius: 8px;
            display: none;
        }

        .result-value {
            font-size: 36px;
            font-weight: bold;
            color: var(--pass);
            text-align: center;
            margin: 10px 0;
        }

        /* Table */
        .table-responsive { overflow-x: auto; margin-top: 15px; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { border: 1px solid #e5e7eb; padding: 10px; text-align: center; }
        th { background-color: #f3f4f6; color: #374151; }
        select { padding: 5px; border-radius: 4px; width: 100%; border: 1px solid #d1d5db;}

        .status-pass { color: var(--pass); font-weight: bold; }
        .status-fail { color: var(--fail); font-weight: bold; }
        .error-msg { color: #dc2626; font-weight: bold; margin-top: 10px; display: none; padding: 10px; background-color: #fee2e2; border-radius: 6px; }
        .note { font-size: 0.9em; color: #6b7280; margin-top: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h1>üìä ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ß‡∏¥‡∏à‡∏±‡∏¢</h1>

    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('ioc')">1. ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏ï‡∏£‡∏á (IOC)</button>
        <button class="tab-btn" onclick="openTab('alpha')">2. ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏±‡πà‡∏ô (Alpha)</button>
    </div>

    <div id="ioc" class="tab-content active">
        <h3>‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏î‡∏±‡∏ä‡∏ô‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á (IOC)</h3>
        <p class="note">‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á</p>
        
        <div style="display: flex; gap: 15px;">
            <div style="flex: 1;">
                <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</label>
                <input type="number" id="ioc_items" value="5" min="1">
            </div>
            <div style="flex: 1;">
                <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç</label>
                <input type="number" id="ioc_experts" value="3" min="1">
            </div>
        </div>
        
        <div class="btn-group">
            <button class="btn-calc" onclick="createIOCTable()" style="background-color: #4b5563;">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á</button>
            <button class="btn-reset" onclick="resetIOC()">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
        </div>

        <div id="ioc_wrapper" style="display:none;">
            <div id="ioc_print_area">
                <div class="table-responsive">
                    <table id="ioc_table">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
                
                <div id="ioc_result" class="result-card">
                    <h4 style="margin-top:0;">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</h4>
                    <div id="ioc_details"></div>
                </div>
            </div>
            
            <button class="btn-calc" style="margin-top: 15px; width:100%" onclick="calculateIOC()">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå IOC</button>

            <div class="export-area" id="ioc_export_btns" style="display:none;">
                <button class="btn-excel" onclick="exportIOCExcel()">üì• Excel</button>
                <button class="btn-pdf" onclick="exportIOCPDF()">üìÑ PDF</button>
            </div>
        </div>
    </div>

    <div id="alpha" class="tab-content">
        <h3>‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Cronbach's Alpha Coefficient</h3>
        <p class="note">Copy ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏à‡∏≤‡∏Å Excel (‡πÅ‡∏ñ‡∏ß=‡∏Ñ‡∏ô, ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå=‡∏Ç‡πâ‡∏≠) ‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</p>
        
        <div class="input-group">
            <textarea id="alpha_data" placeholder="‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
            <div id="alpha_error" class="error-msg"></div>
        </div>

        <div class="btn-group">
            <button class="btn-calc" onclick="calculateAlpha()">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤ Alpha</button>
            <button class="btn-reset" onclick="resetAlpha()">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
        </div>

        <div id="alpha_result_wrapper" style="display:none;">
            <div id="alpha_print_area" class="result-card" style="display:block;">
                <div style="text-align: center;">‡∏Ñ‡πà‡∏≤‡∏™‡∏±‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏≠‡∏•‡∏ü‡∏≤ (Œ±-coefficient)</div>
                <div class="result-value" id="alpha_value">0.000</div>
                <div id="alpha_interpretation" style="text-align: center; font-weight: bold;"></div>
                <p class="note" style="text-align: center;">
                    (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á N = <span id="n_respondents">0</span>, ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠ = <span id="n_items">0</span>)
                </p>
            </div>

            <div class="export-area">
                <button class="btn-excel" onclick="exportAlphaExcel()">üì• Excel</button>
                <button class="btn-pdf" onclick="exportAlphaPDF()">üìÑ PDF</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Tab Switching ---
    function openTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        event.currentTarget.classList.add('active');
    }

    // ================= IOC LOGIC =================
    function createIOCTable() {
        const items = parseInt(document.getElementById('ioc_items').value);
        const experts = parseInt(document.getElementById('ioc_experts').value);
        
        if(!items || !experts) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô");

        const table = document.getElementById('ioc_table');
        let headerHTML = '<tr><th style="width:50px">‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà</th>';
        for(let i=1; i<=experts; i++) headerHTML += `<th>‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç ${i}</th>`;
        headerHTML += '<th style="width:100px">IOC</th><th style="width:100px">‡∏ú‡∏•</th></tr>';
        
        table.querySelector('thead').innerHTML = headerHTML;

        let bodyHTML = '';
        for(let i=1; i<=items; i++) {
            bodyHTML += `<tr><td>${i}</td>`;
            for(let j=1; j<=experts; j++) {
                bodyHTML += `<td><select class="ioc-input" data-row="${i}"><option value="1">+1</option><option value="0">0</option><option value="-1">-1</option></select></td>`;
            }
            bodyHTML += `<td id="ioc-val-${i}">-</td><td id="ioc-res-${i}">-</td></tr>`;
        }
        table.querySelector('tbody').innerHTML = bodyHTML;
        document.getElementById('ioc_wrapper').style.display = 'block';
        document.getElementById('ioc_result').style.display = 'none';
        document.getElementById('ioc_export_btns').style.display = 'none';
    }

    function calculateIOC() {
        const items = parseInt(document.getElementById('ioc_items').value);
        const experts = parseInt(document.getElementById('ioc_experts').value);
        const inputs = document.querySelectorAll('.ioc-input');
        
        let scores = {};
        inputs.forEach(inp => {
            const row = inp.getAttribute('data-row');
            scores[row] = (scores[row] || 0) + parseInt(inp.value);
        });

        let passCount = 0;
        let detailsHTML = "<ul style='text-align:left;'>";

        for(let i=1; i<=items; i++) {
            let ioc = (scores[i] || 0) / experts;
            let passed = ioc >= 0.5;
            
            document.getElementById(`ioc-val-${i}`).innerText = ioc.toFixed(2);
            document.getElementById(`ioc-res-${i}`).innerHTML = passed 
                ? '<span class="status-pass">‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ</span>' : '<span class="status-fail">‡∏ï‡∏±‡∏î‡∏≠‡∏≠‡∏Å</span>';

            if(passed) passCount++;
            else detailsHTML += `<li>‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà ${i}: IOC = ${ioc.toFixed(2)} <span class="status-fail">(‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á)</span></li>`;
        }
        detailsHTML += "</ul>";

        const detailDiv = document.getElementById('ioc_details');
        document.getElementById('ioc_result').style.display = 'block';
        document.getElementById('ioc_export_btns').style.display = 'flex';
        
        if(passCount === items) {
            detailDiv.innerHTML = `<p class="status-pass" style="font-size:18px">‚úÖ ‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏ó‡∏∏‡∏Å‡∏Ç‡πâ‡∏≠ (IOC ‚â• 0.5)</p>`;
        } else {
            detailDiv.innerHTML = `<p>‡∏ú‡πà‡∏≤‡∏ô ${passCount} ‡∏Ç‡πâ‡∏≠, <span class="status-fail">‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô ${items - passCount} ‡∏Ç‡πâ‡∏≠</span>:</p>` + detailsHTML;
        }
    }

    function resetIOC() {
        document.getElementById('ioc_items').value = 5;
        document.getElementById('ioc_experts').value = 3;
        document.getElementById('ioc_wrapper').style.display = 'none';
    }

    // --- Export IOC ---
    function exportIOCExcel() {
        // Clone table to modify values (convert select to text) for export
        let originalTable = document.getElementById('ioc_table');
        let tableClone = originalTable.cloneNode(true);
        
        // Replace selects with their values in the clone
        let inputs = originalTable.querySelectorAll('.ioc-input');
        let cloneInputs = tableClone.querySelectorAll('.ioc-input'); // Selects in clone
        
        inputs.forEach((inp, index) => {
            let val = inp.options[inp.selectedIndex].text;
            let parent = cloneInputs[index].parentElement;
            parent.innerHTML = val; // Replace select with text
        });

        var wb = XLSX.utils.table_to_book(tableClone, {sheet: "IOC Results"});
        XLSX.writeFile(wb, 'IOC_Analysis_Result.xlsx');
    }

    function exportIOCPDF() {
        var element = document.getElementById('ioc_print_area');
        var opt = {
            margin:       0.5,
            filename:     'IOC_Report.pdf',
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2 },
            jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
        };
        html2pdf().set(opt).from(element).save();
    }


    // ================= ALPHA LOGIC =================
    function calculateAlpha() {
        const rawText = document.getElementById('alpha_data').value.trim();
        const errorBox = document.getElementById('alpha_error');
        errorBox.style.display = 'none';

        if(!rawText) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");

        let validData = [];
        const lines = rawText.split('\n');
        
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            if (line === '') continue;
            const parts = line.split(/[\t, ]+/);
            const rowNumbers = parts.map(p => parseFloat(p));
            if (!rowNumbers.some(isNaN) && rowNumbers.length > 1) {
                validData.push(rowNumbers);
            }
        }

        if (validData.length < 2) {
            errorBox.innerText = "‚ùå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠ (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 2 ‡πÅ‡∏ñ‡∏ß ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç)";
            errorBox.style.display = 'block';
            return;
        }

        const n = validData.length;
        const k = validData[0].length;

        let sumItemVar = 0;
        for(let col=0; col<k; col++) {
            let colData = validData.map(row => row[col]);
            sumItemVar += getVariance(colData);
        }

        let totalScores = validData.map(row => row.reduce((a, b) => a + b, 0));
        let totalVar = getVariance(totalScores);

        if (totalVar === 0) {
            errorBox.innerText = "‚ùå ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏õ‡∏£‡∏õ‡∏£‡∏ß‡∏ô‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô 0 (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)";
            errorBox.style.display = 'block';
            document.getElementById('alpha_result_wrapper').style.display = 'none';
            return;
        }

        let alpha = (k / (k - 1)) * (1 - (sumItemVar / totalVar));

        document.getElementById('alpha_result_wrapper').style.display = 'block';
        document.getElementById('alpha_value').innerText = alpha.toFixed(4);
        document.getElementById('n_respondents').innerText = n;
        document.getElementById('n_items').innerText = k;

        let text = "", color = "";
        if(alpha >= 0.9) { text = "‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏î‡∏µ‡∏°‡∏≤‡∏Å (Excellent)"; color = "#047857"; }
        else if(alpha >= 0.8) { text = "‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏î‡∏µ (Good)"; color = "#059669"; }
        else if(alpha >= 0.7) { text = "‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ (Acceptable)"; color = "#d97706"; }
        else if(alpha >= 0.6) { text = "‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πà‡∏≤‡∏™‡∏á‡∏™‡∏±‡∏¢ (Questionable)"; color = "#ca8a04"; }
        else { text = "‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏î‡∏µ/‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á (Poor)"; color = "#dc2626"; }
        
        const interpDiv = document.getElementById('alpha_interpretation');
        interpDiv.innerText = text;
        interpDiv.style.color = color;
    }

    function getVariance(arr) {
        const n = arr.length;
        if (n <= 1) return 0;
        const mean = arr.reduce((a, b) => a + b) / n;
        return arr.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b) / (n - 1);
    }

    function resetAlpha() {
        document.getElementById('alpha_data').value = "";
        document.getElementById('alpha_result_wrapper').style.display = 'none';
        document.getElementById('alpha_error').style.display = 'none';
    }

    // --- Export Alpha ---
    function exportAlphaExcel() {
        const val = document.getElementById('alpha_value').innerText;
        const n = document.getElementById('n_respondents').innerText;
        const k = document.getElementById('n_items').innerText;
        const interp = document.getElementById('alpha_interpretation').innerText;

        const data = [
            ["Report", "Cronbach's Alpha Analysis"],
            ["Date", new Date().toLocaleString()],
            [],
            ["Metric", "Value"],
            ["Alpha Coefficient", parseFloat(val)],
            ["Interpretation", interp],
            ["Respondents (N)", parseInt(n)],
            ["Items (Questions)", parseInt(k)]
        ];

        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(data);
        XLSX.utils.book_append_sheet(wb, ws, "Alpha Result");
        XLSX.writeFile(wb, 'Alpha_Result.xlsx');
    }

    function exportAlphaPDF() {
        var element = document.getElementById('alpha_print_area');
        var opt = {
            margin:       0.5,
            filename:     'Alpha_Report.pdf',
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2 },
            jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
        };
        html2pdf().set(opt).from(element).save();
    }

</script>

</body>
</html>
